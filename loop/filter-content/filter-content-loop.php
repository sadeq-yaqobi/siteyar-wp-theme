<?php
 add_action('wp_ajax_sy_filter_content', 'sy_filter_content'); add_action('wp_ajax_nopriv_sy_filter_content', 'sy_filter_content'); function sy_filter_content() { if (!isset($_POST['_nonce']) && !wp_verify_nonce($_POST['_nonce'])) { wp_send_json([ 'error' => true, 'message' => 'دسترسی غیر مجاز است', ], 403); } $user_ids = isset($_POST['userID']) ? array_map('intval', $_POST['userID']) : []; $post_term_ids = isset($_POST['postTermID']) ? array_map('intval', $_POST['postTermID']) : []; $tech_term_ids = isset($_POST['techTermID']) ? array_map('intval', $_POST['techTermID']) : []; $meta_post_types =$_POST['metaPostType'] ?? ''; $filter_content_query = $_POST['filterContentQuery'] ?? ''; $page_name = $_POST['pageName']; if (empty($post_term_ids) && empty($tech_term_ids) && empty($meta_post_types) && empty($user_ids) || $filter_content_query == '1') { update_option('_sy_filter_content', '1'); if (!empty($page_name)) { $post_type = $page_name; }else{ $post_type = ['post', 'tech']; } $args = [ 'post_type' => $post_type, 'posts_per_page' => 3, 'paged' => $_POST['paged'], 'status'=>'publish' ]; } elseif (empty($post_term_ids) && empty($tech_term_ids) && empty($user_ids) || $filter_content_query == '2') { update_option('_sy_filter_content', '2'); if (!empty($page_name)) { $post_type = $page_name; }else{ $post_type = ['post', 'tech']; } $args = [ 'post_type' => $post_type, 'posts_per_page' => 3, 'paged' => $_POST['paged'], 'status'=>'publish', 'meta_query' => [ [ 'key' => '_sy_post_types', 'value' => $meta_post_types, 'compare' => 'LIKE' ] ] ]; } elseif (empty($post_term_ids) && empty($tech_term_ids) && empty($meta_post_types) || $filter_content_query == '3') { update_option('_sy_filter_content', '3'); if (!empty($page_name)) { $post_type = $page_name; }else{ $post_type = ['post', 'tech']; } $args = [ 'post_type' => $post_type, 'posts_per_page' => 3, 'paged' => $_POST['paged'], 'status'=>'publish', 'author__in' => $user_ids, ]; } elseif (empty($post_term_ids) && empty($tech_term_ids) || $filter_content_query == '4') { update_option('_sy_filter_content', '4'); if (!empty($page_name)) { $post_type = $page_name; }else{ $post_type = ['post', 'tech']; } $args = [ 'post_type' => $post_type, 'posts_per_page' => 3, 'paged' => $_POST['paged'], 'author__in' => $user_ids, 'status'=>'publish', 'meta_query' => [ [ 'key' => '_sy_post_types', 'value' => $meta_post_types, 'compare' => 'LIKE' ] ] ]; } else { update_option('_sy_filter_content', '5'); if (!empty($page_name)) { $post_type = $page_name; }else{ $post_type = ['post', 'tech']; } $args = [ 'post_type' => $post_type, 'posts_per_page' => 3, 'paged' => $_POST['paged'], 'author__in' => $user_ids, 'status'=>'publish', 'tax_query' => [ 'relation' => 'OR', [ 'taxonomy' => 'category', 'field' => 'term_id', 'terms' => $post_term_ids, 'include_children' => false, ], [ 'taxonomy' => 'cat-tech', 'field' => 'term_id', 'terms' => $tech_term_ids, 'include_children' => false, ], ], 'meta_query' => [ [ 'key' => '_sy_post_types', 'value' => $meta_post_types, 'compare' => 'LIKE' ] ] ]; } $the_query = new WP_Query($args); if ($the_query->have_posts()) : $html_output = ''; while ($the_query->have_posts()): $the_query->the_post(); $html_output .= sy_archive_filter_html_output(); endwhile; wp_send_json([ 'success' => true, 'message' => 'فیلتر با موفقیت اعمال شد', 'content' => $html_output, 'total_posts_num' => $the_query->found_posts, 'max_page' => $the_query->max_num_pages, 'filter_content_query' => get_option('_sy_filter_content'), ], 200); else: wp_send_json([ 'error' => true, 'message' => 'پستی یافت نشد', ], 404); endif; wp_reset_postdata(); }